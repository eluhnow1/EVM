<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Campaign - DeFund Me</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
    <!-- Add Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Include SVG icons -->
    <div id="svg-icons" class="hidden"></div>

    <header class="header">
        <div class="navbar">
            <div class="container navbar__container">
                <a href="index.html" class="navbar__brand">
                    <svg class="icon navbar__logo" aria-hidden="true">
                        <use xlink:href="#icon-ethereum"></use>
                    </svg>
                    DeFund Me
                </a>
                <div class="navbar__menu">
                    <a href="index.html" class="navbar__link">Home</a>
                    <a href="#" class="navbar__link">About</a>
                    <a href="#" class="navbar__link">How It Works</a>
                </div>
                <div class="navbar__actions">
                    <a href="javascript:history.back()" class="btn btn--secondary">
                        <svg class="icon btn-icon" aria-hidden="true">
                            <use xlink:href="#icon-home"></use>
                        </svg>
                        Back to Campaign
                    </a>
                </div>
            </div>
        </div>
        
        <div class="header__wave">
            <svg preserveAspectRatio="none" width="100%" height="100%" viewBox="0 0 1440 100" fill="white">
                <path d="M0,64L60,58.7C120,53,240,43,360,42.7C480,43,600,53,720,58.7C840,64,960,64,1080,58.7C1200,53,1320,43,1380,37.3L1440,32L1440,100L1380,100C1320,100,1200,100,1080,100C960,100,840,100,720,100C600,100,480,100,360,100C240,100,120,100,60,100L0,100Z"></path>
            </svg>
        </div>
    </header>

    <main>
        <section class="edit-campaign">
            <div class="container">
                <h1 class="section-title">Edit Campaign</h1>
                
                <div id="edit-campaign-form-container" class="animate-fade-in">
                    <form id="edit-campaign-form" class="form">
                        <input type="hidden" id="campaign-id">
                        
                        <div class="form__group">
                            <label for="campaign-name" class="form__label">Campaign Name</label>
                            <input type="text" id="campaign-name" class="form__control" placeholder="Give your campaign a name" maxlength="100" required>
                            <div class="form__help">Be clear and descriptive</div>
                            <div class="form__char-count"><span id="name-char-count">0</span>/100</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-description" class="form__label">Description</label>
                            <textarea id="campaign-description" class="form__control" placeholder="Describe your campaign in detail" rows="5" maxlength="500" required></textarea>
                            <div class="form__help">Explain what the funds will be used for and why people should donate</div>
                            <div class="form__char-count"><span id="desc-char-count">0</span>/500</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-goal" class="form__label">Funding Goal (ETH)</label>
                            <input type="number" id="campaign-goal" class="form__control" placeholder="e.g., 1.5" min="0.01" step="0.01" required>
                            <div class="form__help" id="goal-help-text">Current amount raised: <span id="current-raised" class="font-bold">0</span> ETH (Goal cannot be less than this amount)</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-image" class="form__label">Image URL</label>
                            <input type="url" id="campaign-image" class="form__control" placeholder="Paste an image URL" maxlength="200" required>
                            <div class="form__help">
                                Provide a URL to an image that represents your campaign<br>
                                For long URLs, use a direct image service like <a href="https://imgur.com" target="_blank" rel="noopener">Imgur</a>
                            </div>
                            <div class="form__char-count"><span id="url-char-count">0</span>/200</div>
                            
                            <div class="form__preview">
                                <p class="form__preview-label">Image Preview:</p>
                                <img id="image-preview" class="form__preview-image" src="https://placehold.co/600x400?text=No+Image" alt="Preview">
                            </div>
                        </div>
                        
                        <div class="form__actions">
                            <button type="submit" id="update-btn" class="btn btn--primary">
                                <svg class="icon btn-icon" aria-hidden="true">
                                    <use xlink:href="#icon-edit"></use>
                                </svg>
                                Update Campaign
                            </button>
                            <a href="javascript:history.back()" class="btn btn--secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer__wave">
            <svg preserveAspectRatio="none" width="100%" height="100%" viewBox="0 0 1440 100" fill="var(--gray-100)">
                <path d="M0,64L60,58.7C120,53,240,43,360,42.7C480,43,600,53,720,58.7C840,64,960,64,1080,58.7C1200,53,1320,43,1380,37.3L1440,32L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z"></path>
            </svg>
        </div>
        <div class="container">
            <div class="footer__content">
                <div class="footer__logo">DeFund Me</div>
                <p class="footer__tagline">A decentralized fundraising platform powered by Ethereum</p>
                
                <div class="footer__links">
                    <a href="#" class="footer__link">Privacy Policy</a>
                    <a href="#" class="footer__link">Terms of Service</a>
                    <a href="#" class="footer__link">Contact</a>
                    <a href="#" class="footer__link">About</a>
                </div>
                
                <div class="footer__social">
                    <a href="#" class="footer__social-item" aria-label="Twitter">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-twitter"></use>
                        </svg>
                    </a>
                    <a href="#" class="footer__social-item" aria-label="GitHub">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-github"></use>
                        </svg>
                    </a>
                    <a href="#" class="footer__social-item" aria-label="Discord">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-discord"></use>
                        </svg>
                    </a>
                </div>
                
                <p class="footer__copyright">&copy; 2025 DeFund Me. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/web3.js"></script>
    <script src="js/contract.js"></script>
    <script src="js/app.js"></script>
    <script src="js/ui.js"></script>
    
    <!-- Load SVG Icons -->
    <script>
        // Load SVG icons
        fetch('icons.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('svg-icons').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading SVG icons:', error);
            });
    </script>

    <!-- Enhanced edit campaign page script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add character counters
            const nameField = document.getElementById('campaign-name');
            const descField = document.getElementById('campaign-description');
            const imageUrlField = document.getElementById('campaign-image');
            
            // Name field counter
            nameField.addEventListener('input', function() {
                const count = this.value.length;
                const countEl = document.getElementById('name-char-count');
                if (countEl) {
                    countEl.textContent = count;
                    if (count > 80) { // Show warning when close to limit
                        countEl.parentElement.classList.add('form__char-count--limit');
                    } else {
                        countEl.parentElement.classList.remove('form__char-count--limit');
                    }
                }
            });
            
            // Description field counter
            descField.addEventListener('input', function() {
                const count = this.value.length;
                const countEl = document.getElementById('desc-char-count');
                if (countEl) {
                    countEl.textContent = count;
                    if (count > 400) { // Show warning when close to limit
                        countEl.parentElement.classList.add('form__char-count--limit');
                    } else {
                        countEl.parentElement.classList.remove('form__char-count--limit');
                    }
                }
            });
            
            // Image URL field counter and preview
            imageUrlField.addEventListener('input', function() {
                const count = this.value.length;
                const countEl = document.getElementById('url-char-count');
                if (countEl) {
                    countEl.textContent = count;
                    if (count > 160) { // Show warning when close to limit
                        countEl.parentElement.classList.add('form__char-count--limit');
                    } else {
                        countEl.parentElement.classList.remove('form__char-count--limit');
                    }
                }
                
                // Update image preview
                const previewImg = document.getElementById('image-preview');
                if (previewImg) {
                    if (this.value) {
                        previewImg.src = this.value;
                        // Handle image load errors
                        previewImg.onerror = function() {
                            this.src = 'https://placehold.co/600x400?text=Image+Error';
                        };
                    } else {
                        previewImg.src = 'https://placehold.co/600x400?text=No+Image';
                    }
                }
            });
            
            // Override initEditCampaignPage function
            window.initEditCampaignPage = async function() {
                const editForm = document.getElementById('edit-campaign-form');
                const editFormContainer = document.getElementById('edit-campaign-form-container');
                const updateBtn = document.getElementById('update-btn');
                
                // Get campaign ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const campaignId = urlParams.get('id');
                
                if (!campaignId) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Make sure web3 and contract are initialized
                if (await initWeb3() && await initContract()) {
                    // If wallet is not connected, show connect button
                    if (!isConnected) {
                        editFormContainer.innerHTML = `
                            <div class="wallet-notice animate-fade-in">
                                <h3 class="wallet-notice__title">Wallet Connection Required</h3>
                                <p class="wallet-notice__text">Please connect your wallet to edit this campaign.</p>
                                <button id="connect-wallet-btn" class="btn btn--primary">
                                    <svg class="icon btn-icon" aria-hidden="true">
                                        <use xlink:href="#icon-wallet"></use>
                                    </svg>
                                    Connect Wallet
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('connect-wallet-btn').addEventListener('click', async () => {
                            if (await connectWallet()) {
                                window.location.reload();
                            }
                        });
                        
                        return;
                    }
                    
                    // Show loading state
                    editForm.innerHTML = `
                        <div class="loading">
                            <div class="loading__spinner"></div>
                            <p class="loading__text">Loading campaign details...</p>
                        </div>
                    `;
                    
                    // Get campaign details
                    const campaign = await getCampaign(campaignId);
                    
                    if (!campaign) {
                        editFormContainer.innerHTML = `
                            <div class="wallet-notice animate-fade-in">
                                <h3 class="wallet-notice__title">Campaign Not Found</h3>
                                <p class="wallet-notice__text">The campaign you're trying to edit does not exist or there was an error loading it.</p>
                                <a href="index.html" class="btn btn--primary">Go to Home</a>
                            </div>
                        `;
                        return;
                    }
                    
                    // Check if current user is the campaign creator
                    if (accounts[0].toLowerCase() !== campaign.creator.toLowerCase()) {
                        editFormContainer.innerHTML = `
                            <div class="wallet-notice animate-fade-in">
                                <h3 class="wallet-notice__title">Access Denied</h3>
                                <p class="wallet-notice__text">Only the campaign creator can edit this campaign.</p>
                                <a href="campaign.html?id=${campaignId}" class="btn btn--primary">
                                    <svg class="icon btn-icon" aria-hidden="true">
                                        <use xlink:href="#icon-campaign"></use>
                                    </svg>
                                    View Campaign
                                </a>
                            </div>
                        `;
                        return;
                    }
                    
                    // Restore the form HTML
                    editForm.innerHTML = `
                        <input type="hidden" id="campaign-id">
                        
                        <div class="form__group">
                            <label for="campaign-name" class="form__label">Campaign Name</label>
                            <input type="text" id="campaign-name" class="form__control" placeholder="Give your campaign a name" maxlength="100" required>
                            <div class="form__help">Be clear and descriptive</div>
                            <div class="form__char-count"><span id="name-char-count">0</span>/100</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-description" class="form__label">Description</label>
                            <textarea id="campaign-description" class="form__control" placeholder="Describe your campaign in detail" rows="5" maxlength="500" required></textarea>
                            <div class="form__help">Explain what the funds will be used for and why people should donate</div>
                            <div class="form__char-count"><span id="desc-char-count">0</span>/500</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-goal" class="form__label">Funding Goal (ETH)</label>
                            <input type="number" id="campaign-goal" class="form__control" placeholder="e.g., 1.5" min="0.01" step="0.01" required>
                            <div class="form__help" id="goal-help-text">Current amount raised: <span id="current-raised" class="font-bold">0</span> ETH (Goal cannot be less than this amount)</div>
                        </div>
                        
                        <div class="form__group">
                            <label for="campaign-image" class="form__label">Image URL</label>
                            <input type="url" id="campaign-image" class="form__control" placeholder="Paste an image URL" maxlength="200" required>
                            <div class="form__help">
                                Provide a URL to an image that represents your campaign<br>
                                For long URLs, use a direct image service like <a href="https://imgur.com" target="_blank" rel="noopener">Imgur</a>
                            </div>
                            <div class="form__char-count"><span id="url-char-count">0</span>/200</div>
                            
                            <div class="form__preview">
                                <p class="form__preview-label">Image Preview:</p>
                                <img id="image-preview" class="form__preview-image" src="https://placehold.co/600x400?text=No+Image" alt="Preview">
                            </div>
                        </div>
                        
                        <div class="form__actions">
                            <button type="submit" id="update-btn" class="btn btn--primary">
                                <svg class="icon btn-icon" aria-hidden="true">
                                    <use xlink:href="#icon-edit"></use>
                                </svg>
                                Update Campaign
                            </button>
                            <a href="javascript:history.back()" class="btn btn--secondary">Cancel</a>
                        </div>
                    `;
                    
                    // Re-get the form elements
                    const nameField = document.getElementById('campaign-name');
                    const descriptionField = document.getElementById('campaign-description');
                    const goalField = document.getElementById('campaign-goal');
                    const imageUrlField = document.getElementById('campaign-image');
                    const updateBtn = document.getElementById('update-btn');
                    
                    // Fill form with campaign details
                    document.getElementById('campaign-id').value = campaignId;
                    nameField.value = campaign.name;
                    descriptionField.value = campaign.description;
                    goalField.value = campaign.goal;
                    imageUrlField.value = campaign.imageUrl;
                    
                    // Update character counters
                    nameField.dispatchEvent(new Event('input'));
                    descriptionField.dispatchEvent(new Event('input'));
                    imageUrlField.dispatchEvent(new Event('input'));
                    
                    // Show current amount raised
                    const currentRaised = document.getElementById('current-raised');
                    if (currentRaised) {
                        currentRaised.textContent = campaign.amountRaised;
                        goalField.min = campaign.amountRaised;
                    }
                    
                    // Handle form submission
                    editForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const id = document.getElementById('campaign-id').value;
                        const name = nameField.value;
                        const description = descriptionField.value;
                        const goal = goalField.value;
                        const imageUrl = imageUrlField.value;
                        
                        // Validate input
                        const validationError = validateCampaignInput(name, description, goal, imageUrl);
                        if (validationError) {
                            window.showToast(validationError, 'error');
                            return;
                        }
                        
                        // Check that goal is not less than amount raised
                        if (parseFloat(goal) < parseFloat(campaign.amountRaised)) {
                            window.showToast(`Goal cannot be less than the current amount raised (${campaign.amountRaised} ETH)`, 'error');
                            return;
                        }
                        
                        updateBtn.disabled = true;
                        updateBtn.innerHTML = `
                            <svg class="icon icon--loading btn-icon" aria-hidden="true">
                                <use xlink:href="#icon-loading"></use>
                            </svg>
                            Updating Campaign...
                        `;
                        
                        try {
                            const success = await updateCampaign(id, name, description, goal, imageUrl);
                            
                            if (success) {
                                window.showToast('Campaign updated successfully!', 'success');
                                
                                // Show success state before redirecting
                                editFormContainer.innerHTML = `
                                    <div class="success-message animate-fade-in">
                                        <svg class="icon icon--lg" aria-hidden="true">
                                            <use xlink:href="#icon-check"></use>
                                        </svg>
                                        <h2>Campaign Updated Successfully!</h2>
                                        <p>Your campaign has been updated. Redirecting to campaign page...</p>
                                    </div>
                                `;
                                
                                // Style for success message
                                const style = document.createElement('style');
                                style.textContent = `
                                    .success-message {
                                        text-align: center;
                                        padding: 3rem;
                                        background-color: white;
                                        border-radius: var(--radius-lg);
                                        box-shadow: var(--shadow);
                                    }
                                    .success-message .icon {
                                        width: 4rem;
                                        height: 4rem;
                                        color: var(--success);
                                        margin-bottom: 1.5rem;
                                    }
                                `;
                                document.head.appendChild(style);
                                
                                // Redirect after delay
                                setTimeout(() => {
                                    window.location.href = `campaign.html?id=${id}`;
                                }, 2000);
                            } else {
                                updateBtn.disabled = false;
                                updateBtn.innerHTML = `
                                    <svg class="icon btn-icon" aria-hidden="true">
                                        <use xlink:href="#icon-edit"></use>
                                    </svg>
                                    Update Campaign
                                `;
                            }
                        } catch (error) {
                            console.error("Campaign update error:", error);
                            window.showToast(`Error updating campaign: ${error.message || 'Unknown error'}`, 'error');
                            updateBtn.disabled = false;
                            updateBtn.innerHTML = `
                                <svg class="icon btn-icon" aria-hidden="true">
                                    <use xlink:href="#icon-edit"></use>
                                </svg>
                                Update Campaign
                            `;
                        }
                    });
                } else {
                    editFormContainer.innerHTML = `
                        <div class="wallet-notice animate-fade-in">
                            <h3 class="wallet-notice__title">Connection Error</h3>
                            <p class="wallet-notice__text">Failed to connect to the blockchain. Please make sure MetaMask is installed and connected to the Sepolia test network.</p>
                            <a href="https://metamask.io/" target="_blank" rel="noopener" class="btn btn--primary">
                                Get MetaMask
                            </a>
                        </div>
                    `;
                }
            };
        });
    </script>
</body>
</html>